### Unified Upsert System in dbsetup.js (Post-Schema Refactor)

The `perp_data` table employs a unified upsert mechanism via the `insertData(allRawData)` method, which aggregates incoming perpspec-specific records (e.g., from OHLCV, RSI, LSR API scripts) into a single row per unique composite key `(ts BIGINT, symbol TEXT, exchange TEXT)` using a Map-based merge in JavaScript before executing (real-time "-c.js" scripts) a bulk `INSERT ... ON CONFLICT (ts, symbol, exchange) DO UPDATE SET` query. Backfill scripts ("-h.js" files, e.g., 1-all-lsr-h.js, 1-all-ohlcv-h.js) use `ON CONFLICT DO NOTHING` for maximum speed on existing data, assuming clean API fetches without overwrites, while real-time scripts (-c files) use `DO UPDATE` to refresh fields on conflicts for immediate consistency. This consolidation populates all relevant fields (e.g., `o`, `h`, `l`, `c`, `v` from ohlcv sources; `rsi1`, `rsi60` from rsi sources; `lsr` from lsr sources) additively in the unified row, reducing storage redundancy by ~93% while preserving data integrity through field-specific assignments (e.g., `row.o = record.o` for ohlcv matches). The `perpspec` column is retained as JSONB (default `[]`) to track populated data types as an array of full perpspec names (e.g., `["bin-ohlcv", "bin-rsi"]`), updated via array append operations in the merge (e.g., `perpspec = row.perpspec ? [...row.perpspec, 'bin-rsi'] : ['bin-rsi']` if not already present, using Postgres JSONB operators like `||` or `jsonb_agg` in upserts for idempotency). A `notes` TEXT column has been added to `perp_data` for optional metadata (e.g., 'farcaster' or 'manual-override'), left null by default in API scripts (no insertion at this time to avoid overhead), but can be set manually via SQL command line for specific rows (e.g., `UPDATE perp_data SET notes = 'manual note' WHERE ts = 1760812380000n AND symbol = 'ETH' AND exchange = 'bin';`). Columns `interval` and `source` have been dropped (ALTER TABLE), as all ingested data is standardized to 1-minute intervals (via `apiUtils.toMillis` flooring in API processors), eliminating redundancy. For queries, direct access by perpspec (e.g., `WHERE perpspec = 'bin-rsi'`) is deprecated; instead, use the composite key with targeted columns (e.g., `SELECT * FROM perp_data WHERE ts = 1760812380000n AND symbol = 'ETH' AND exchange = 'bin' AND rsi1 IS NOT NULL ORDER BY ts ASC, symbol ASC, exchange ASC` to retrieve rows with RSI data, or `WHERE perpspec @> '["bin-rsi"]'` for JSONB array containment). This structure ensures efficient, sorted retrieval (leveraging the PK for natural ordering) and compatibility with calc-metrics.js aggregation, while future API scripts must collect multi-source data before calling `insertData` for seamless merging. NOTE: rsi perpspec is now bin-rsi. byb-tv and okx-tv, and bon-lq/byb-lq/okx-lq all do not have historical data. NOTE: okx-oi and okx-lsr only has 5 days historical data vailable from API.

