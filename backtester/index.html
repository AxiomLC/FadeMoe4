<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>FadeAI Backtester Console</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      background:#0b0b0b; color:#ddd; 
      font-family: 'Consolas', monospace; 
      padding:15px;
      overflow-x: hidden;
    }
    h1 { color:#00c7a1; font-size:1.5em; margin-bottom:10px; }
    h2 { color:#00c7a1; font-size:1.1em; margin-bottom:8px; }
    
    select, input, textarea {
      background:#1a1a1a; color:#eee; border:1px solid #333; 
      padding:4px 6px; border-radius:4px; font-size:0.9em;
    }
    
    button {
      background:#009688; border:none; color:#fff; 
      padding:8px 16px; border-radius:5px;
      margin:5px; cursor:pointer; font-weight:bold;
      font-size:0.95em;
    }
    button:hover { background:#00bfa5; }
    
    .top-controls {
      display:flex; gap:20px; align-items:flex-start;
      padding:10px; background:#111; border-radius:6px;
      margin-bottom:10px;
    }
    
    .control-group {
      display:flex; flex-direction:column; gap:5px;
    }
    .control-group label { font-size:0.85em; color:#999; }
    
    #symbols, #mtToken {
      min-width:120px; height:100px;
    }
    
    .params-section {
      background:#111; border-radius:6px; padding:12px;
      margin-bottom:10px;
    }
    
    .params-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 8px;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .param-item {
      display:flex; align-items:center; gap:4px;
      padding:6px; background:#1a1a1a; border-radius:4px;
      flex-wrap: wrap;
    }
    
    .param-item label {
      flex: 1;
      min-width: 80px;
      font-size:0.85em;
    }
    
    .param-item select {
      padding:2px 4px;
      font-size:0.8em;
    }
    
    .param-item .exchange-select {
      width:50px;
    }
    
    .param-item .timeframe-select {
      width:70px;
    }
    
    .param-item .operator-select {
      width:45px;
    }
    
    .param-item input[type="number"] {
      width:65px; padding:2px;
    }
    
    .param-item input[type="checkbox"] {
      width:18px; height:18px; cursor:pointer;
    }
    
    .algo-section {
      background:#111; border-radius:6px; padding:12px;
      margin-bottom:10px;
    }
    
    #algoBox {
      width:100%; background:#1a1a1a; color:#8f8; 
      font-family:monospace; padding:10px; 
      border-radius:6px; min-height:60px;
      border:1px solid #333;
      font-size:0.95em;
    }
    
    .button-row {
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0;
    }
    
    .results-section {
      background:#111; border-radius:6px; padding:12px;
      margin-bottom:10px;
    }
    
    #output {
      background:#1a1a1a; color:#9f9; padding:12px; 
      border-radius:6px; max-height:250px; 
      overflow:auto; font-size:0.9em;
      white-space: pre-wrap;
    }
    
    .best-scheme {
      background:#1a1a1a; padding:8px; border-radius:4px;
      margin-top:8px; color:#ff9;
      font-size:0.9em;
    }
    
    .direction-toggle {
      display:flex; gap:10px; align-items:center;
    }
    
    .direction-toggle label {
      display:flex; align-items:center; gap:5px;
      cursor:pointer;
    }
    
    .ai-chat-section {
      background:#111; border-radius:6px; padding:12px;
    }
    
    #aiChatHistory {
      background:#1a1a1a; padding:10px; border-radius:6px;
      min-height:150px; max-height:300px;
      overflow-y:auto; margin-bottom:10px;
      font-size:0.9em;
    }
    
    .chat-message {
      margin-bottom:10px; padding:8px; border-radius:4px;
    }
    
    .chat-user {
      background:#1a3a3a; color:#8ff;
    }
    
    .chat-ai {
      background:#2a1a2a; color:#f8f;
    }
    
    #aiPromptInput {
      width:100%; min-height:60px; resize:vertical;
      margin-bottom:8px;
    }
  </style>
</head>
<body>

  <h1>ðŸ§  FadeAI Backtester Console</h1>

  <div class="top-controls">
    <div class="control-group">
      <label>Target Symbols:</label>
      <select id="symbols" multiple></select>
    </div>
    
    <div class="control-group">
      <label>MT Token (Reference):</label>
      <select id="mtToken" multiple></select>
    </div>
    
    <div class="control-group">
      <label>Direction:</label>
      <div class="direction-toggle">
        <label><input type="radio" name="direction" value="long" checked> Long</label>
        <label><input type="radio" name="direction" value="short"> Short</label>
      </div>
    </div>
  </div>

  <div class="params-section">
    <h2>ðŸ“Š Setup ALGO Parameters</h2>
    <div class="params-grid" id="param-container"></div>
  </div>

  <div class="algo-section">
    <h2>ðŸ“œ Generated Algo</h2>
    <div id="algoBox" contenteditable="true">Select parameters and click Generate Algo</div>
  </div>

  <div class="button-row">
    <button onclick="generateAlgo()">ðŸ§© Generate Algo</button>
    <button onclick="saveStrategy()">ðŸ’¾ Save JSON</button>
    <button onclick="runBacktest()">ðŸš€ Run Backtest</button>
  </div>

  <div class="results-section">
    <h2>ðŸ“ˆ Backtest Results</h2>
    <div id="output">Results will appear here...</div>
    <div id="bestScheme" class="best-scheme" style="display:none;"></div>
  </div>

  <div class="ai-chat-section">
    <h2>ðŸ¤– AI Strategy Advisor</h2>
    <div id="aiChatHistory"></div>
    <textarea id="aiPromptInput" placeholder="Ask AI for strategy ideas... e.g., 'Show me divergence between bin and byb funding rates for meme coins'"></textarea>
    <div class="button-row">
      <button onclick="sendAIPrompt()">ðŸ’¬ Ask AI</button>
      <button onclick="getQuickSuggestions()">âš¡ Quick Suggestions</button>
    </div>
  </div>

  <script>
    const ops = [">","<",">=","<=","="];
    const exchanges = ["bin","byb","okx"];
    const timeframes = ["_chg_1m","_chg_5m","_chg_10m"];
    let baseParams = [];
    let columns = [];
    let strategy = {};
    let chatHistory = [];

    async function init(){
      await loadSymbols();
      await loadColumns();
      renderParamGrid();
    }

    async function loadSymbols(){
      const res = await fetch('/symbols');
      const syms = await res.json();
      
      // Populate both symbol selectors
      const symbolSel = document.getElementById('symbols');
      const mtSel = document.getElementById('mtToken');
      
      syms.forEach(s=>{
        const o1=document.createElement('option');
        o1.value=o1.textContent=s.symbol;
        symbolSel.appendChild(o1);
        
        const o2=document.createElement('option');
        o2.value=o2.textContent=s.symbol;
        mtSel.appendChild(o2);
      });
    }

    async function loadColumns(){
      const res = await fetch('/columns');
      columns = await res.json();
      
      // Extract base param names (remove _chg_1m, _chg_5m, _chg_10m suffixes)
      const paramSet = new Set();
      columns.forEach(col => {
        const base = col.replace(/_chg_(1m|5m|10m)$/,'');
        if(base !== col) paramSet.add(base);
      });
      baseParams = Array.from(paramSet).sort();
    }

    function renderParamGrid(){
      const cont=document.getElementById('param-container');
      cont.innerHTML = baseParams.map(param=>`
        <div class="param-item">
          <label title="${param}">${param}</label>
          <select id="${param}_exch" class="exchange-select">
            ${exchanges.map(ex=>`<option>${ex}</option>`).join('')}
          </select>
          <select id="${param}_time" class="timeframe-select">
            ${timeframes.map(tf=>`<option>${tf}</option>`).join('')}
          </select>
          <select id="${param}_op" class="operator-select">
            ${ops.map(o=>`<option>${o}</option>`).join('')}
          </select>
          <input type="number" id="${param}_val" step="0.01" placeholder="val">
          <input type="checkbox" id="${param}_chk">
        </div>
      `).join('');
    }

    function generateAlgo(){
      const chosen=[];
      baseParams.forEach(p=>{
        if(document.getElementById(`${p}_chk`).checked){
          const exch=document.getElementById(`${p}_exch`).value;
          const time=document.getElementById(`${p}_time`).value;
          const op=document.getElementById(`${p}_op`).value;
          const val=document.getElementById(`${p}_val`).value;
          chosen.push(`${exch} ${p}${time} ${op} ${val}`);
        }
      });
      const sentence = chosen.join(' + ');
      document.getElementById('algoBox').textContent = sentence || 'No parameters selected';
    }

    async function saveStrategy(){
      const conds=[];
      baseParams.forEach(p=>{
        if(document.getElementById(`${p}_chk`).checked){
          const exch=document.getElementById(`${p}_exch`).value;
          const time=document.getElementById(`${p}_time`).value;
          const fullParam = p + time;
          
          conds.push({
            exchange: exch,
            param: fullParam,
            operator:document.getElementById(`${p}_op`).value,
            value:parseFloat(document.getElementById(`${p}_val`).value)
          });
        }
      });
      
      if(conds.length === 0){
        alert('Please select at least one parameter!');
        return;
      }
      
      const symbols=[...document.getElementById('symbols').selectedOptions].map(o=>o.value);
      if(symbols.length === 0){
        alert('Please select at least one symbol!');
        return;
      }
      
      const mtTokens=[...document.getElementById('mtToken').selectedOptions].map(o=>o.value);
      const direction=document.querySelector('input[name="direction"]:checked').value;
      
      strategy = { 
        name: `${symbols[0]}_${direction}_${Date.now()}`,
        symbols, 
        mtTokens,
        conditions:conds,
        direction: direction === 'long' ? 'mBuy' : 'mSell'
      };
      
      await fetch('/strategy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(strategy)});
      alert('Strategy saved to strategy.json!');
    }

    async function runBacktest(){
      document.getElementById('output').textContent='ðŸš€ Running backtest...';
      document.getElementById('bestScheme').style.display='none';
      
      try {
        const res=await fetch('/backtest',{method:'POST'});
        const json=await res.json();
        const {stats,trades,bestScheme}=json;
        
        const summary=`Total Trades: ${stats.total}
Win Rate: ${stats.winRate}%
TP1 Hits: ${stats.tp1}
TP2 Hits: ${stats.tp2}
Stop Loss: ${stats.loss}

Top 10 Trades:
${trades.slice(0,10).map(t=>`${t.symbol} â†’ ${t.outcome}`).join('\n')}`;
        
        document.getElementById('output').textContent=summary;
        
        if(bestScheme) {
          const schemeDiv = document.getElementById('bestScheme');
          schemeDiv.textContent = `âœ¨ Best Scheme Found: TP1=${bestScheme.tp1}% | TP2=${bestScheme.tp2}% | SL=${bestScheme.sl}%`;
          schemeDiv.style.display='block';
        }
      } catch(e) {
        document.getElementById('output').textContent='Error: '+e.message;
      }
    }

    function addChatMessage(role, text){
      const chatDiv = document.getElementById('aiChatHistory');
      const msg = document.createElement('div');
      msg.className = `chat-message chat-${role}`;
      msg.textContent = `${role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'} ${text}`;
      chatDiv.appendChild(msg);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function sendAIPrompt(){
      const input = document.getElementById('aiPromptInput');
      const prompt = input.value.trim();
      
      if(!prompt) {
        alert('Please enter a prompt');
        return;
      }
      
      addChatMessage('user', prompt);
      input.value = '';
      
      try {
        const res = await fetch('/ai-chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({prompt})
        });
        const data = await res.json();
        
        addChatMessage('ai', data.response);
        
        if(data.suggestedStrategy) {
          document.getElementById('algoBox').textContent = JSON.stringify(data.suggestedStrategy, null, 2);
        }
      } catch(e) {
        addChatMessage('ai', 'Error: ' + e.message);
      }
    }

    async function getQuickSuggestions(){
      addChatMessage('user', 'Generate quick strategy suggestions');
      
      try {
        const res=await fetch('/suggest',{method:'POST'});
        const data=await res.json();
        
        addChatMessage('ai', `Generated ${data.suggestions.length} strategies. Check the Algo box!`);
        document.getElementById('algoBox').textContent=JSON.stringify(data.suggestions,null,2);
      } catch(e) {
        addChatMessage('ai', 'Error: '+e.message);
      }
    }

    init();
  </script>
</body>
</html>