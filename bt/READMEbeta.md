# bt/ - FadeAI Backtester (Current Beta Implementation)

## Overview
This is the current beta version of the FadeAI Backtester, renamed and restructured from the original `backtester/` for simplicity. It provides a web-based interface for defining trading strategies (via JSON conditions), running backtests on historical perpetual futures data from the `perp_metrics` table, and generating AI strategy suggestions. 

Key features:
- **Simple Strategy Input**: JSON-based conditions (no full AlgoQL parsing yetâ€”placeholders exist).
- **Backtesting Engine**: Queries `perp_metrics` for % change filters (e.g., `oi_chg_1m > 1.5`), optimizes TP/SL schemes (grid search: 125 combos), simulates trades, and outputs stats (win rate, PF).
- **UI**: Basic frontend for building/saving strategies and viewing results.
- **AI Suggestions**: OpenAI-powered ideas (or stub fallback) based on trending tokens and recent metrics.
- **DB Integration**: Uses new `db/dbsetup.js` schema (`perp_metrics` with chg_1m/5m/10m columns, hypertables, 10-day retention).
- **Limitations**: No advanced AlgoQL parsing or statistical discovery yet (files are placeholders). Assumes data in `perp_metrics` (populate via backfill scripts).

**Date**: 24 Oct 2025  
**Version**: Beta 1.0 (Renamed to bt/, fixed imports, SQL bugs resolved)  
**Status**: Basic backtesting works (e.g., DOGE;Long;byb_oi_chg_1m>1.5). Test with sample data.

---

## File Structure
```
bt/
â”‚
â”œâ”€â”€ app.js                      # Main Express server: APIs (/backtest, /suggest), serves index.html
â”œâ”€â”€ index.html                  # Frontend UI: Strategy builder, buttons for APIs, results display
â”œâ”€â”€ bt.js                       # Core backtest engine: Query building, simulation, TP/SL optimization
â”œâ”€â”€ ai-agent.js                 # AI module: suggestStrategy() for OpenAI suggestions (renamed from server.js)
â”‚
â”œâ”€â”€ strategy.json               # Current strategy (JSON: symbols, conditions, etc.) - generated by UI
â”œâ”€â”€ results.json                # Backtest output (stats, trades, bestScheme) - auto-generated
â”œâ”€â”€ ai_suggestions.json         # AI-generated strategies - auto-generated
â”‚
â”œâ”€â”€ algoql-parser.js            # Placeholder: Future AlgoQL string â†’ JSON/SQL parser (unused)
â”œâ”€â”€ ai-anal.js                  # Placeholder: Future statistical analysis/discovery (unused)
â”‚
â””â”€â”€ READMEbeta.md               # This file: Current summary
```

**Notes**:
- No subdirs like `results/` yet (app.js prunes if created).
- Dependencies: External (`db/dbsetup.js` in root), npm (`express`, `pg`, `openai`, `node-fetch`, `dotenv`).

---

## System Architecture (Current)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        BROWSER/UI            â”‚
â”‚     (index.html - Fetch)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       app.js (Server)       â”‚
â”‚  (Express: APIs, Static)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ bt.js (Backtest Engine)
           â””â”€ ai-agent.js (AI Suggestions)
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL/TimescaleDB    â”‚
â”‚    (perp_metrics table)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **No Full Modules**: Placeholders (`algoql-parser.js`, `ai-anal.js`) not integratedâ€”backtests use direct JSON/SQL.
- **Data Flow**: UI â†’ POST /strategy (save JSON) â†’ POST /backtest (query/simulate) â†’ results.json.

---

## How to Run
1. **Prerequisites**:
   - Node.js (v14+).
   - PostgreSQL/TimescaleDB running (with `.env`: DB_HOST, DB_PORT=5432, DB_USER, DB_PASSWORD, DB_NAME).
   - Install deps: `npm install express pg openai node-fetch dotenv` (in project root).
   - Init DB: `node db/dbsetup.js` (creates `perp_metrics`, indexes, retention).
   - Populate data: Run backfill/continuous scripts (e.g., `-h.js`) to add rows to `perp_metrics` (ts, symbol, exchange, chg columns).

2. **Start Server**:
   ```
   node bt/app.js
   ```
   - Output: "ðŸš€ bt/ Backtester Server running at http://localhost:8000".
   - Open: `http://localhost:8000` (loads index.html UI).

3. **Test Flow**:
   - **UI**: Click "Load Symbols/Columns" (fetches from DB).
   - **Build Strategy**: Select symbols (e.g., DOGE), add condition (e.g., byb oi_chg_1m > 1.5), save.
   - **Run Backtest**: Click button â†’ Console shows query/progress; UI shows JSON results (stats, trades).
   - **AI Suggest**: Enter prompt (e.g., "DOGE short") â†’ Gets ideas (OpenAI or stub).
   - **Health**: Visit `/health` â†’ Confirms DB connection.

4. **CLI Tests**:
   - Backtest: Ensure `strategy.json` exists â†’ `node bt/app.js` (then POST /backtest via curl).
   - AI: `node bt/ai-agent.js --run "Suggest BTC long"`.

**Troubleshooting**:
- **Blank UI**: Check browser console (F12); ensure `index.html` in `bt/`.
- **DB Errors**: Verify `.env` creds; run `dbsetup.js`.
- **0 Rows in Backtest**: No matching dataâ€”loosen conditions or add sample rows (e.g., INSERT INTO perp_metrics (ts, symbol, exchange, oi_chg_1m) VALUES (...)).
- **Port Conflict**: Change PORT=8001 in app.js.

---

## API Endpoints (in app.js)
- **GET /**: Serves index.html (UI).
- **GET /symbols**: List unique symbols from `perp_metrics` (JSON: `{symbols: ["BTC", "DOGE"]}`).
- **GET /columns**: List % chg columns (e.g., `["oi_chg_1m", "pfr_chg_5m"]`).
- **POST /strategy**: Save strategy JSON to `strategy.json` (body: `{name, symbols, direction, conditions: [{exchange, param, operator, value}]}`).
- **POST /backtest**: Run backtest via bt.js (requires strategy.json; returns `{stats, trades, bestScheme}`).
- **POST /suggest**: AI suggestions via ai-agent.js (body: `{prompt}`; returns array of `{algoql, pf, explanation}`).
- **GET /health**: System status (DB connected?).

**Example Curl**:
```
# Save strategy
curl -X POST -H "Content-Type: application/json" -d '{"name":"Test","symbols":["DOGE"],"direction":"Long","conditions":[{"exchange":"byb","param":"oi_chg_1m","operator":">","value":1.5}]}' http://localhost:8000/strategy

# Run backtest
curl -X POST http://localhost:8000/backtest
```

---

## Strategy Format (JSON)
Saved by UI/POST /strategy:
```json
{
  "name": "UI Built Strategy",
  "symbols": ["DOGE"],  // Array of symbols (or "ALL")
  "direction": "Long",  // "Long" or "Short"
  "conditions": [  // Array of filters
    {
      "exchange": "byb",  // bin, byb, okx
      "param": "oi_chg_1m",  // e.g., pfr_chg_5m (from columns)
      "operator": ">",  // >, <, >=, <=
      "value": 1.5  // Numeric threshold
    }
  ],
  "mtTokens": []  // Optional: MT symbols for JOIN (empty skips)
}
```
- Multi-condition: AND within exchange, OR across (e.g., byb AND bin).
- Backtest: Queries matching rows, simulates trades on close prices.

---

## Backtest Details (in bt.js)
- **Query**: Dynamic SQL on `perp_metrics` (WHERE symbol IN (...), exchange conditions, LIMIT 10000).
- **Optimization**: Grid search TP1 (0.3-1.0%), TP2 (0.6-1.5%), SL (0.05-0.2%) â†’ Best by score (winRate *2 + TP2 bias - SL penalty).
- **Simulation**: Forward-walk: Enter on signal, exit on TP1/TP2/SL (50% partials), % from close.
- **Output** (`results.json`): `{stats: {total, winRate, pf, ...}, trades: [...], bestScheme: {...}}`.
- **Logging**: Success/warnings to `perp_status`, errors to `perp_errors`.

---

## AI Suggestions (in ai-agent.js)
- **suggestStrategy(prompt)**: Uses OpenAI (gpt-4o-mini) with trending (CoinGecko), recent metrics (1h avg from DB), columns.
- **Output**: JSON array `{algoql: "DOGE;Short;byb_oi_chg_1m< -0.5", pf: 1.2, explanation: "..."}`.
- **Fallback**: Stub examples if no API key (set OPENAI_API_KEY in .env).
- **CLI**: `node bt/ai-agent.js --run "prompt"`.

---

## Dependencies & Setup
- **NPM**: `express` (server), `pg` (DB), `openai` (AI), `node-fetch` (trends), `dotenv` (.env).
- **DB Schema** (from dbsetup.js): `perp_metrics` (ts BIGINT, symbol/exchange TEXT, o/h/l/c/v NUMERIC, chg_1m/5m/10m NUMERIC(7,3), PK(ts,symbol,exchange)).
- **.env Example**:
  ```
  DB_HOST=localhost
  DB_PORT=5432
  DB_USER=postgres
  DB_PASSWORD=yourpass
  DB_NAME=fademoe
  OPENAI_API_KEY=sk-...
  MAX_TOKENS=1500
  ```
- **Performance**: Queries <10s with indexes; 125 schemes on 10k rows ~5-10s.

---

## Current Limitations & Next Steps
- **No AlgoQL Parsing**: Strategies are raw JSON (no string input like "DOGE;Long;byb_oi>1.5"). Integrate `algoql-parser.js` for full syntax.
- **Basic AI**: Suggestions are prompt-based; no statistical discovery (e.g., correlations). Implement `ai-anal.js` for `/ai-discover`.
- **No Pruning/UI Polish**: results/ not auto-created; UI is basic (add horizontal selectors fully).
- **Data Required**: Backtests need populated `perp_metrics` (use your scripts).
- **Future** (Per Original README):
  - Phase 2: Full UI with AlgoQL box.
  - Phase 3: Correlation analysis in ai-anal.js.
  - Phase 4: Chat history in ai-agent.js.
  - Enhancements: Parallel tests, walk-forward, Monte Carlo.

For questions, check console/logs or run health check. Last Updated: 24 Oct 2025
